<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOEFL Listening ‚Äî Academic Talk Practice</title>
  <style>
    /* TOEFL/ETS Design System */
    :root {
      --ets-blue: #0066b3;
      --ets-blue-dark: #004c87;
      --ets-blue-light: #e6f2fa;
      --bg: #f0f2f5;
      --card: #ffffff;
      --border: #d1d5db;
      --text: #1a1a1a;
      --muted: #6b7280;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --header-height: 48px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 24px;
    }

    .header {
      height: var(--header-height);
      background: var(--ets-blue);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      font-size: 15px;
      font-weight: 600;
      box-shadow: 0 1px 4px rgba(0,0,0,.15);
    }
    .header-home {
      color: #fff;
      text-decoration: none;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s;
      margin-right: 12px;
    }
    .header-home:hover { background: rgba(255,255,255,.15); }
    .header-left { display: flex; align-items: center; }
    .header-select {
      background: rgba(255,255,255,.2);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      padding: 6px 12px;
      cursor: pointer;
      min-width: 200px;
    }
    .header-select:hover { background: rgba(255,255,255,.25); }
    .header-select option { color: var(--text); background: var(--card); }

    .main { max-width: 800px; margin: 0 auto; padding: 20px 16px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.06);
    }
    .card h2 { font-size: 20px; margin-bottom: 20px; color: var(--ets-blue-dark); }

    .progress-bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0;
      margin-bottom: 24px;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      width: 100%;
    }
    .progress-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--border);
      transition: all .3s;
      cursor: pointer;
      flex-shrink: 0;
    }
    .progress-dot:hover {
      transform: scale(1.2);
      box-shadow: 0 0 0 2px var(--ets-blue-light);
    }
    .progress-dot.active { background: var(--ets-blue); transform: scale(1.2); }
    .progress-dot.completed { background: var(--success); }
    .progress-connector {
      height: 2px;
      background: var(--border);
      flex: 1;
      min-width: 4px;
    }
    .progress-connector.completed { background: var(--success); }

    .talk-section {
      background: var(--ets-blue-light);
      border: 2px solid var(--ets-blue);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .talk-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .talk-icon { font-size: 32px; }
    .talk-title { font-size: 16px; font-weight: 700; color: var(--ets-blue-dark); }
    .talk-info { font-size: 13px; color: var(--muted); margin-top: 8px; }
    .audio-player-wrapper { margin-top: 16px; }
    .audio-player-wrapper audio { width: 100%; max-width: 500px; }

    .questions-section { margin-top: 32px; }
    .question-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .question-number {
      display: inline-block;
      background: var(--ets-blue);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    .question-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
      margin-bottom: 16px;
    }
    .options-list { list-style: none; padding: 0; margin: 0; }
    .option-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--card);
    }
    .option-item:hover:not(.disabled) {
      border-color: var(--ets-blue);
      background: var(--ets-blue-light);
    }
    .option-item.selected {
      border-color: var(--ets-blue);
      background: var(--ets-blue-light);
    }
    .option-item.correct { border-color: var(--success); background: #d1fae5; }
    .option-item.incorrect { border-color: var(--error); background: #fee2e2; }
    .option-item.disabled { cursor: not-allowed; opacity: 0.7; }
    .option-label { font-weight: 600; color: var(--ets-blue-dark); margin-right: 8px; }
    .option-text { color: var(--text); }
    .feedback {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }
    .feedback.show { display: block; }
    .feedback.correct {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid var(--success);
    }
    .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid var(--error);
    }
    .feedback-explanation { margin-top: 8px; font-size: 12px; color: var(--muted); }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      background: var(--ets-blue);
      color: #fff;
    }
    .btn:hover:not(:disabled) { background: var(--ets-blue-dark); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) {
      background: #f3f4f6;
      border-color: var(--ets-blue);
      color: var(--ets-blue);
    }
    .btn-group {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 24px;
    }

    .results-summary {
      background: var(--card);
      border: 2px solid var(--success);
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      margin-top: 24px;
    }
    .results-score { font-size: 36px; font-weight: 700; color: var(--ets-blue-dark); margin: 12px 0; }
    .results-text { font-size: 14px; color: var(--muted); margin-top: 8px; }

    .instructions {
      background: #fefce8;
      border: 1px solid #fde68a;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .instructions h3 { font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 8px; }
    .instructions ul { font-size: 13px; color: #78350f; line-height: 1.8; padding-left: 20px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!--
  REVIEW LOG (for maintainers; not shown to users)
  Scripts + MC items: this file (ACADEMIC_TALK_SETS[*].talks[].text, .questions[]).
  Detailed item/set edit log: docs/item-review-log.md (Listening: Academic Talk section)
  -->
  <header class="header">
    <div class="header-left">
      <a href="index.html" class="header-home">‚Üê Home</a>
      <div class="title">TOEFL¬Æ Listening ‚Äî Academic Talk Practice</div>
    </div>
    <select class="header-select" id="setSelect" onchange="switchSet()">
    </select>
    <div id="headerProgress">Talk 1 / 1</div>
  </header>

  <main class="main">
    <div class="card">
      <h2>Listen to an Academic Talk</h2>

      <div class="progress-bar" id="progressBar"></div>

      <div class="instructions">
        <h3>Instructions</h3>
        <ul>
          <li>You will hear a short academic talk (e.g., from a professor or instructor).</li>
          <li>After listening, answer the two questions that follow.</li>
          <li>You can listen to each talk only once.</li>
          <li>Take notes while listening.</li>
          <li>Review explanations after selecting your answers.</li>
        </ul>
      </div>

      <div class="talk-section" id="talkSection">
        <div class="talk-header">
          <span class="talk-icon">üéì</span>
          <div>
            <div class="talk-title" id="talkTitle">Loading...</div>
            <div class="talk-info" id="talkInfo">Context: Loading...</div>
          </div>
        </div>
        <div class="audio-player-wrapper">
          <audio id="talkAudio" controls style="width: 100%; max-width: 500px;">
            <source id="audioSource" src="" type="audio/mpeg">
            Your browser does not support audio playback.
          </audio>
        </div>
        <div style="margin-top: 16px; text-align: center;">
          <button class="btn" id="startBtn" onclick="startTalk()">Start Practice</button>
          <button class="btn btn-secondary hidden" id="replayBtn" onclick="replayTalk()">Replay</button>
        </div>
      </div>

      <div class="questions-section hidden" id="questionsSection">
        <div class="section-title">Answer Questions</div>
        <div id="questionsContainer"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" id="prevBtn" onclick="previousTalk()" disabled>‚Üê Previous</button>
          <button class="btn" id="checkBtn" onclick="checkAnswers()" disabled>Check Answers</button>
          <button class="btn hidden" id="nextBtn" onclick="nextTalk()">Next ‚Üí</button>
        </div>
      </div>

      <div class="results-summary hidden" id="resultsSummary">
        <div style="font-size: 18px; font-weight: 700; color: var(--ets-blue-dark);">Practice Complete!</div>
        <div class="results-score" id="resultsScore">0/0</div>
        <div class="results-text" id="resultsText">Accuracy: 0%</div>
        <div class="btn-group" style="margin-top: 20px;">
          <button class="btn btn-secondary" onclick="restartPractice()">Restart</button>
          <button class="btn" onclick="reviewAnswers()">Review Answers</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ==================== ACADEMIC TALK SETS (A2‚ÄìC1, 2 talks per tier) ====================
    const ACADEMIC_TALK_SETS = {
      A2: {
        label: 'A2 ‚Äî Academic Talks',
        talks: [
          {
            id: 'A2-01',
            title: 'The Four Seasons',
            context: 'Science class',
            audioFile: 'audio/listening/LT-A2-01.mp3',
            text: 'Hello, everyone. Today we will talk about the four seasons: spring, summer, autumn, and winter. Why do we have different seasons? The main reason is that the Earth is tilted. When your part of the Earth is tilted toward the Sun, you get more sunlight and it is warmer. That is summer. When your part is tilted away from the Sun, you get less sunlight and it is colder. That is winter. In spring and autumn, we are in between, so the weather is mild. In the north, summer is usually from June to August. Winter is from December to February. In spring, flowers grow and leaves come back. In autumn, leaves turn red and yellow and fall from the trees. So the tilt of the Earth and the way it moves around the Sun give us our seasons.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the main purpose of the talk?',
                options: [
                  { label: 'A', text: 'To explain why we have different seasons' },
                  { label: 'B', text: 'To name the months of summer and winter' },
                  { label: 'C', text: 'To describe what happens to leaves in autumn' },
                  { label: 'D', text: 'To compare spring and summer weather' }
                ],
                correct: 'A',
                explanation: 'The talk focuses on why we have seasons: the tilt of the Earth and its movement around the Sun.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, what causes summer to be warmer than winter?',
                options: [
                  { label: 'A', text: 'The Earth is closer to the Sun in summer' },
                  { label: 'B', text: 'Our part of the Earth is tilted toward the Sun in summer' },
                  { label: 'C', text: 'There are more hours of daylight in winter' },
                  { label: 'D', text: 'Flowers and leaves grow in summer' }
                ],
                correct: 'B',
                explanation: 'The speaker states that when your part of the Earth is tilted toward the Sun, you get more sunlight and it is warmer‚Äîthat is summer.'
              }
            ]
          },
          {
            id: 'A2-02',
            title: 'A Day at School',
            context: 'Orientation',
            audioFile: 'audio/listening/LT-A2-02.mp3',
            text: 'Good morning. I will tell you what a typical day at our school looks like. School starts at eight thirty. First, you go to your classroom. The teacher checks your name. Then you have three lessons in the morning. Each lesson is forty-five minutes. At twelve o‚Äôclock we have lunch. You can eat in the cafeteria or bring your own food. After lunch, you have two more lessons. School finishes at three fifteen. On Monday and Wednesday, you can stay for sports or music. Those activities start at half past three. You need to bring a notebook, a pen, and your books every day. If you have questions, ask your teacher or go to the office. Thank you.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the talk mainly about?',
                options: [
                  { label: 'A', text: 'What to bring to school' },
                  { label: 'B', text: 'How to join sports and music' },
                  { label: 'C', text: 'What happens during a typical school day' },
                  { label: 'D', text: 'When the teacher checks your name' }
                ],
                correct: 'C',
                explanation: 'The talk describes a typical day: start time, lessons, lunch, afternoon lessons, and finish time.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, when is lunch?',
                options: [
                  { label: 'A', text: 'At eight thirty' },
                  { label: 'B', text: 'After two lessons' },
                  { label: 'C', text: 'At three fifteen' },
                  { label: 'D', text: 'At twelve o‚Äôclock' }
                ],
                correct: 'D',
                explanation: 'The speaker clearly states that at twelve o‚Äôclock we have lunch.'
              }
            ]
          }
        ]
      },
      B1: {
        label: 'B1 ‚Äî Academic Talks',
        talks: [
          {
            id: 'B1-01',
            title: 'How Libraries Work',
            context: 'Library orientation',
            audioFile: 'audio/listening/LT-B1-01.mp3',
            text: 'Today I will explain how the library works. To borrow a book, you need a library card. You can get one at the desk. You show your card, and we give you the book. You can keep most books for two weeks. If you need more time, you can renew them online or in person. If you return a book after the due date, you pay a fine. The fine is usually a small amount per day. We also have computers you can use for free. You can search for books on our website. If the book you want is in another building, we can bring it here for you. That is called a reserve. It takes one or two days. Do you have any questions?',
            questions: [
              {
                id: 'Q1',
                text: 'What is the main purpose of the talk?',
                options: [
                  { label: 'A', text: 'To explain how to get a library card' },
                  { label: 'B', text: 'To explain how the library works' },
                  { label: 'C', text: 'To describe the reserve service' },
                  { label: 'D', text: 'To tell students about fines' }
                ],
                correct: 'B',
                explanation: 'The talk explains how the library works: borrowing, renewing, fines, computers, and reserve.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, what happens if you return a book after the due date?',
                options: [
                  { label: 'A', text: 'You pay a fine' },
                  { label: 'B', text: 'You cannot borrow again' },
                  { label: 'C', text: 'The book is reserved for someone else' },
                  { label: 'D', text: 'You must get a new card' }
                ],
                correct: 'A',
                explanation: 'The speaker states that if you return a book after the due date, you pay a fine, usually a small amount per day.'
              }
            ]
          },
          {
            id: 'B1-02',
            title: 'Why We Have Weekends',
            context: 'Social studies class',
            audioFile: 'audio/listening/LT-B1-02.mp3',
            text: 'Why do we have weekends? A weekend is usually Saturday and Sunday. In the past, many people worked six days a week. Then laws changed. Workers wanted more rest and time with their families. So in many countries, Saturday and Sunday became free days. That gave people two days to relax, do hobbies, or go out. Schools and offices are closed. Shops may be open. Today we take weekends for granted, but they are a result of social change. Some countries have different days off. For example, in some places Friday and Saturday are the weekend. The idea is the same: a regular break from work or school.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the talk mainly about?',
                options: [
                  { label: 'A', text: 'Which countries have different weekends' },
                  { label: 'B', text: 'What people do on Saturday and Sunday' },
                  { label: 'C', text: 'How many days people worked in the past' },
                  { label: 'D', text: 'Why we have weekends' }
                ],
                correct: 'D',
                explanation: 'The talk explains why we have weekends: history, workers‚Äô desire for rest, and the result of social change.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, why did Saturday and Sunday become free days in many countries?',
                options: [
                  { label: 'A', text: 'Schools and offices wanted to close' },
                  { label: 'B', text: 'Shops needed to stay open' },
                  { label: 'C', text: 'Workers wanted more rest and time with family' },
                  { label: 'D', text: 'Laws required a six-day week' }
                ],
                correct: 'C',
                explanation: 'The speaker states that workers wanted more rest and time with their families, and laws changed so that Saturday and Sunday became free days.'
              }
            ]
          }
        ]
      },
      B2: {
        label: 'B2 ‚Äî Academic Talks',
        talks: [
          {
            id: 'B2-01',
            title: 'Photosynthesis and Light',
            context: 'Biology class',
            audioFile: 'audio/listening/LT-B2-01.mp3',
            text: 'Good morning. Today I want to talk briefly about how plants use light to make food. This process is called photosynthesis. In photosynthesis, plants take in carbon dioxide from the air and water from the soil. They use energy from sunlight to convert these into glucose, which is a type of sugar, and they release oxygen as a byproduct. The key part of the plant where this happens is the chloroplast. Inside the chloroplast you find chlorophyll, the green pigment that absorbs light. So when we say plants are green, it is because chlorophyll reflects green light and absorbs mainly red and blue. Without enough light, photosynthesis slows down, which is why plants grown in dim conditions often look pale or weak. Understanding this process is essential for topics like agriculture and climate, because plants absorb a lot of the carbon dioxide we produce.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the main purpose of the talk?',
                options: [
                  { label: 'A', text: 'To explain how plants use light to produce food' },
                  { label: 'B', text: 'To compare different types of plant pigments' },
                  { label: 'C', text: 'To describe the structure of chloroplasts' },
                  { label: 'D', text: 'To discuss the effects of dim light on growth' }
                ],
                correct: 'A',
                explanation: 'The talk focuses on photosynthesis: how plants use light to convert CO‚ÇÇ and water into glucose and release oxygen.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, why do plants appear green?',
                options: [
                  { label: 'A', text: 'Chlorophyll absorbs only green light' },
                  { label: 'B', text: 'Chlorophyll reflects green light and absorbs red and blue' },
                  { label: 'C', text: 'Glucose in the leaves is green' },
                  { label: 'D', text: 'Carbon dioxide in the leaves causes the color' }
                ],
                correct: 'B',
                explanation: 'The professor states that chlorophyll reflects green light and absorbs mainly red and blue, so plants appear green.'
              }
            ]
          },
          {
            id: 'B2-02',
            title: 'Roman Aqueducts',
            context: 'History class',
            audioFile: 'audio/listening/LT-B2-02.mp3',
            text: 'Today we will look at one of the Romans\' greatest engineering achievements: the aqueduct. Aqueducts were structures designed to bring fresh water from distant sources into cities. The Romans did not invent the idea of moving water through channels, but they built aqueducts on a scale that had never been seen before. Some of their aqueducts ran for dozens of miles. The key to their success was the use of a slight downward slope over the whole distance. Gravity did the work; water flowed from the source to the city without pumps. The channels were often covered to keep the water clean and to reduce evaporation. When the path had to cross a valley, the Romans built arches to support the channel at the right height. Many of these arches are still standing today. The water supplied public fountains, baths, and sometimes private homes, and it was crucial for the growth and health of Roman cities.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the talk mainly about?',
                options: [
                  { label: 'A', text: 'How the Romans brought water into cities using aqueducts' },
                  { label: 'B', text: 'Why the Romans invented the first aqueducts' },
                  { label: 'C', text: 'How Roman fountains and baths were built' },
                  { label: 'D', text: 'Why arches were used in Roman construction' }
                ],
                correct: 'A',
                explanation: 'The talk focuses on Roman aqueducts: structures that brought fresh water from distant sources into cities.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, how did water move through the aqueducts?',
                options: [
                  { label: 'A', text: 'By pumps powered by slaves' },
                  { label: 'B', text: 'By gravity, using a slight downward slope' },
                  { label: 'C', text: 'By heating the water to create pressure' },
                  { label: 'D', text: 'By covering the channels to reduce evaporation' }
                ],
                correct: 'B',
                explanation: 'The professor states that the key was a slight downward slope so that gravity moved the water without pumps.'
              }
            ]
          }
        ]
      },
      C1: {
        label: 'C1 ‚Äî Academic Talks',
        talks: [
          {
            id: 'C1-01',
            title: 'Climate Feedback Loops',
            context: 'Environmental science',
            audioFile: 'audio/listening/LT-C1-01.mp3',
            text: 'In this lecture I want to introduce the concept of feedback loops in the climate system. A feedback loop is when a change in one part of the system leads to more change in the same direction. Take the ice-albedo effect. Ice and snow reflect a lot of sunlight back into space. When global temperatures rise, ice melts and exposes darker ocean or land. Those surfaces absorb more heat, so temperatures rise further. That is a positive feedback: warming leads to more warming. Another example is water vapour. Warmer air holds more moisture, and water vapour is a greenhouse gas, so more vapour can amplify the initial warming. Not all feedbacks are positive. For instance, more plant growth in some regions might take up more carbon dioxide. But the net effect of the main feedbacks is to amplify climate change. Understanding these mechanisms is critical for predicting how the climate will respond to rising emissions.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the main purpose of the talk?',
                options: [
                  { label: 'A', text: 'To compare ice and water vapour' },
                  { label: 'B', text: 'To introduce feedback loops in the climate system' },
                  { label: 'C', text: 'To explain why plant growth reduces warming' },
                  { label: 'D', text: 'To predict future emissions' }
                ],
                correct: 'B',
                explanation: 'The talk introduces feedback loops in the climate system and gives examples such as ice-albedo and water vapour.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, what is one effect of melting ice in the climate system?',
                options: [
                  { label: 'A', text: 'Darker surfaces absorb more heat and temperatures rise further' },
                  { label: 'B', text: 'More sunlight is reflected into space' },
                  { label: 'C', text: 'Water vapour in the air decreases' },
                  { label: 'D', text: 'Plant growth increases and absorbs CO‚ÇÇ' }
                ],
                correct: 'A',
                explanation: 'The professor states that when ice melts, darker ocean or land is exposed; those surfaces absorb more heat, so temperatures rise further‚Äîa positive feedback.'
              }
            ]
          },
          {
            id: 'C1-02',
            title: 'Historical Causation',
            context: 'History seminar',
            audioFile: 'audio/listening/LT-C1-02.mp3',
            text: 'Today we are going to discuss how historians explain major changes in history. It is tempting to point to a single event‚Äîa battle, a law, a discovery‚Äîand say that it caused everything that followed. But historians usually argue that big changes have multiple causes. Economic conditions, ideas, technology, and chance all play a role. For example, the rise of industrialisation in Europe depended on new machines, but also on access to raw materials, labour, capital, and political stability. No one factor alone is sufficient. Historians also distinguish between short-term and long-term causes. A revolution might be triggered by a specific crisis, but the causes may have built up over decades. So when you read or write history, look for several causes and how they interact, rather than a single turning point.',
            questions: [
              {
                id: 'Q1',
                text: 'What is the talk mainly about?',
                options: [
                  { label: 'A', text: 'Why battles and laws are the most important causes' },
                  { label: 'B', text: 'The role of machines in industrialisation' },
                  { label: 'C', text: 'How historians explain major changes using multiple causes' },
                  { label: 'D', text: 'The difference between short-term and long-term events' }
                ],
                correct: 'C',
                explanation: 'The talk focuses on how historians explain major changes: multiple causes, not a single event, and the interaction of factors.'
              },
              {
                id: 'Q2',
                text: 'According to the talk, how do historians typically explain major historical changes?',
                options: [
                  { label: 'A', text: 'By identifying one key event as the turning point' },
                  { label: 'B', text: 'By focusing only on economic conditions' },
                  { label: 'C', text: 'By comparing short-term and long-term crises' },
                  { label: 'D', text: 'By looking for multiple causes and how they interact' }
                ],
                correct: 'D',
                explanation: 'The speaker states that historians usually argue that big changes have multiple causes and that we should look for several causes and how they interact.'
              }
            ]
          }
        ]
      }
    };

    // ==================== STATE ====================
    const STORAGE_KEY = 'toefl-listening-academic-talk-state';
    let currentSetId = 'A2';
    let currentTalkIndex = 0;
    let answers = {};
    let hasStarted = false;

    // ==================== INIT ====================
    function init() {
      const select = document.getElementById('setSelect');
      select.innerHTML = '';
      for (const [id, set] of Object.entries(ACADEMIC_TALK_SETS)) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = set.label;
        select.appendChild(opt);
      }

      const saved = restoreState();
      if (saved) {
        currentSetId = saved.setId;
        currentTalkIndex = saved.talkIndex ?? 0;
      }
      select.value = currentSetId;
      updateUI();
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          setId: currentSetId,
          talkIndex: currentTalkIndex
        }));
      } catch (e) { /* ignore */ }
    }

    function restoreState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const data = JSON.parse(raw);
        if (!data.setId || !ACADEMIC_TALK_SETS[data.setId]) return null;
        return data;
      } catch (e) { return null; }
    }

    function updateUI() {
      const set = ACADEMIC_TALK_SETS[currentSetId];
      const talk = set.talks[currentTalkIndex];
      const total = set.talks.length;

      document.getElementById('headerProgress').textContent = `Talk ${currentTalkIndex + 1} / ${total}`;
      updateProgressBar();

      document.getElementById('talkTitle').textContent = talk.title;
      document.getElementById('talkInfo').textContent = `Context: ${talk.context}`;

      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('replayBtn').classList.add('hidden');
      document.getElementById('questionsSection').classList.add('hidden');
      document.getElementById('resultsSummary').classList.add('hidden');
      hasStarted = false;

      document.getElementById('prevBtn').disabled = currentTalkIndex === 0;
      document.getElementById('checkBtn').disabled = true;
      document.getElementById('nextBtn').classList.add('hidden');

      saveState();
    }

    function updateProgressBar() {
      const container = document.getElementById('progressBar');
      container.innerHTML = '';
      const set = ACADEMIC_TALK_SETS[currentSetId];
      const total = set.talks.length;

      for (let i = 0; i < total; i++) {
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        dot.setAttribute('data-index', i);
        dot.setAttribute('title', `Talk ${i + 1}`);
        if (i < currentTalkIndex) dot.classList.add('completed');
        else if (i === currentTalkIndex) dot.classList.add('active');
        dot.addEventListener('click', () => {
          if (i !== currentTalkIndex) {
            currentTalkIndex = i;
            updateUI();
          }
        });
        container.appendChild(dot);
        if (i < total - 1) {
          const connector = document.createElement('div');
          connector.className = 'progress-connector';
          if (i < currentTalkIndex) connector.classList.add('completed');
          container.appendChild(connector);
        }
      }
    }

    function startTalk() {
      const set = ACADEMIC_TALK_SETS[currentSetId];
      const talk = set.talks[currentTalkIndex];

      hasStarted = true;
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('replayBtn').classList.remove('hidden');

      if (talk.audioFile) {
        document.getElementById('audioSource').src = talk.audioFile;
        document.getElementById('talkAudio').load();
      } else {
        showTalkText(talk);
      }

      setTimeout(() => showQuestions(talk), 1000);
    }

    function replayTalk() {
      const audio = document.getElementById('talkAudio');
      audio.currentTime = 0;
      audio.play();
    }

    function showTalkText(talk) {
      let textHtml = '<div style="margin-top: 16px; padding: 16px; background: #fff; border-radius: 6px; font-size: 13px; line-height: 1.8;"><div style="font-weight: 600; margin-bottom: 12px; color: var(--ets-blue-dark);">Talk transcript:</div>';
      textHtml += `<div style="margin-bottom: 8px;">${talk.text}</div></div>`;
      const audioWrapper = document.querySelector('.audio-player-wrapper');
      const existingText = audioWrapper.parentElement.querySelector('.text-display');
      if (existingText) existingText.remove();
      audioWrapper.insertAdjacentHTML('afterend', `<div class="text-display">${textHtml}</div>`);
    }

    function showQuestions(talk) {
      document.getElementById('questionsSection').classList.remove('hidden');
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';

      talk.questions.forEach((q, qIndex) => {
        const questionCard = document.createElement('div');
        questionCard.className = 'question-card';
        questionCard.innerHTML = `
          <div class="question-number">Question ${qIndex + 1}</div>
          <div class="question-text">${q.text}</div>
          <ul class="options-list" id="options-${talk.id}-${q.id}">
            ${q.options.map(opt => `
              <li class="option-item" data-question="${q.id}" data-option="${opt.label}" onclick="selectOption('${talk.id}', '${q.id}', '${opt.label}')">
                <span class="option-label">${opt.label}.</span>
                <span class="option-text">${opt.text}</span>
              </li>
            `).join('')}
          </ul>
          <div class="feedback" id="feedback-${talk.id}-${q.id}">
            <div class="feedback-explanation"></div>
          </div>
        `;
        container.appendChild(questionCard);
      });

      if (answers[talk.id]) {
        Object.keys(answers[talk.id]).forEach(qId => {
          selectOption(talk.id, qId, answers[talk.id][qId], false);
        });
        document.getElementById('checkBtn').disabled = false;
      }
    }

    function selectOption(talkId, questionId, optionLabel, enableCheck = true) {
      if (!answers[talkId]) answers[talkId] = {};
      answers[talkId][questionId] = optionLabel;

      const options = document.querySelectorAll(`#options-${talkId}-${questionId} .option-item`);
      options.forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.option === optionLabel) opt.classList.add('selected');
      });

      if (enableCheck) {
        const talk = ACADEMIC_TALK_SETS[currentSetId].talks[currentTalkIndex];
        const allAnswered = talk.questions.every(q => answers[talkId] && answers[talkId][q.id]);
        document.getElementById('checkBtn').disabled = !allAnswered;
      }
    }

    function checkAnswers() {
      const set = ACADEMIC_TALK_SETS[currentSetId];
      const talk = set.talks[currentTalkIndex];

      talk.questions.forEach(q => {
        const selected = answers[talk.id] && answers[talk.id][q.id];
        const isCorrect = selected === q.correct;

        const options = document.querySelectorAll(`#options-${talk.id}-${q.id} .option-item`);
        options.forEach(opt => {
          opt.classList.add('disabled');
          if (opt.dataset.option === q.correct) opt.classList.add('correct');
          if (selected && opt.dataset.option === selected && !isCorrect) opt.classList.add('incorrect');
        });

        const feedback = document.getElementById(`feedback-${talk.id}-${q.id}`);
        feedback.classList.add('show', isCorrect ? 'correct' : 'incorrect');
        feedback.innerHTML = `
          <div><strong>${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}</strong></div>
          <div class="feedback-explanation">${q.explanation}</div>
        `;
      });

      document.getElementById('checkBtn').classList.add('hidden');
      document.getElementById('nextBtn').classList.remove('hidden');
      updateProgressBar();
    }

    function previousTalk() {
      if (currentTalkIndex > 0) {
        currentTalkIndex--;
        updateUI();
      }
    }

    function nextTalk() {
      const set = ACADEMIC_TALK_SETS[currentSetId];
      if (currentTalkIndex < set.talks.length - 1) {
        currentTalkIndex++;
        updateUI();
      } else {
        showResults();
      }
    }

    function switchSet() {
      const select = document.getElementById('setSelect');
      if (!ACADEMIC_TALK_SETS[select.value]) return;
      currentSetId = select.value;
      currentTalkIndex = 0;
      answers = {};
      updateUI();
    }

    function showResults() {
      const set = ACADEMIC_TALK_SETS[currentSetId];
      let correct = 0, total = 0;
      set.talks.forEach(t => {
        t.questions.forEach(q => {
          total++;
          const selected = answers[t.id] && answers[t.id][q.id];
          if (selected === q.correct) correct++;
        });
      });
      document.getElementById('questionsSection').classList.add('hidden');
      document.getElementById('resultsSummary').classList.remove('hidden');
      document.getElementById('resultsScore').textContent = `${correct}/${total}`;
      document.getElementById('resultsText').textContent = `Accuracy: ${Math.round(correct / total * 100)}%`;
    }

    function restartPractice() {
      currentTalkIndex = 0;
      answers = {};
      updateUI();
    }

    function reviewAnswers() {
      currentTalkIndex = 0;
      updateUI();
      setTimeout(() => {
        const set = ACADEMIC_TALK_SETS[currentSetId];
        set.talks.forEach(t => {
          if (answers[t.id]) {
            startTalk();
            setTimeout(() => checkAnswers(), 500);
          }
        });
      }, 100);
    }

    init();
  </script>
</body>
</html>
